name: Release Validation

# ADR-0037: Release Validation Observability Flow
# Triggered after semantic-release completion to validate:
# 1. GitHub Release existence
# 2. PyPI package version match
# 3. Production environment health

on:
  workflow_run:
    workflows: ["Semantic Release"]
    types: [completed]
  workflow_dispatch:
    # Allow manual triggering for testing
    inputs:
      release_version:
        description: 'Release version to validate (e.g., v9.0.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  release-validation:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true  # Non-blocking: never fail the release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Earthly
        uses: earthly/actions-setup@v1
        with:
          version: latest

      - name: Setup Doppler CLI
        uses: ./.github/actions/setup-doppler

      - name: Detect release version
        id: release_info
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RELEASE_VERSION="${{ github.event.inputs.release_version }}"
          else
            RELEASE_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          fi

          GITHUB_RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${RELEASE_VERSION}"

          echo "release_version=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
          echo "release_url=${GITHUB_RELEASE_URL}" >> $GITHUB_OUTPUT
          echo "git_commit=${GITHUB_SHA}" >> $GITHUB_OUTPUT

          echo "Release Version: ${RELEASE_VERSION}"
          echo "Release URL: ${GITHUB_RELEASE_URL}"
          echo "Git Commit: ${GITHUB_SHA}"

      - name: Create artifacts directory
        run: mkdir -p artifacts

      - name: Run Earthly validation pipeline
        continue-on-error: true
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
          EARTHLY_CI: true
        run: |
          echo "=========================================="
          echo "Running Earthly Release Validation Pipeline"
          echo "=========================================="

          # Export secrets from Doppler to environment variables
          export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          export CLICKHOUSE_HOST=$(doppler secrets get CLICKHOUSE_HOST --project aws-credentials --config prd --plain)
          export CLICKHOUSE_PORT=$(doppler secrets get CLICKHOUSE_PORT --project aws-credentials --config prd --plain)
          export CLICKHOUSE_USER=$(doppler secrets get CLICKHOUSE_USER --project aws-credentials --config prd --plain)
          export CLICKHOUSE_PASSWORD=$(doppler secrets get CLICKHOUSE_PASSWORD --project aws-credentials --config prd --plain)
          export PUSHOVER_APP_TOKEN=$(doppler secrets get PUSHOVER_APP_TOKEN --project notifications --config prd --plain)
          export PUSHOVER_USER_KEY=$(doppler secrets get PUSHOVER_USER_KEY --project notifications --config prd --plain)

          # Run Earthly pipeline with secrets
          earthly \
            --secret GITHUB_TOKEN="$GITHUB_TOKEN" \
            --secret CLICKHOUSE_HOST="$CLICKHOUSE_HOST" \
            --secret CLICKHOUSE_PORT="$CLICKHOUSE_PORT" \
            --secret CLICKHOUSE_USER="$CLICKHOUSE_USER" \
            --secret CLICKHOUSE_PASSWORD="$CLICKHOUSE_PASSWORD" \
            --secret PUSHOVER_APP_TOKEN="$PUSHOVER_APP_TOKEN" \
            --secret PUSHOVER_USER_KEY="$PUSHOVER_USER_KEY" \
            +release-validation-pipeline \
            --RELEASE_VERSION="${{ steps.release_info.outputs.release_version }}" \
            --GIT_COMMIT="${{ steps.release_info.outputs.git_commit }}" \
            --GITHUB_REPOSITORY="${{ github.repository }}" \
            --GITHUB_RELEASE_URL="${{ steps.release_info.outputs.release_url }}" \
          || echo "Earthly validation pipeline failed (non-fatal)"

      - name: Upload validation artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: release-validation-results
          path: artifacts/*.json
          retention-days: 90

      - name: Summary
        if: always()
        run: |
          echo "## Release Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release**: ${{ steps.release_info.outputs.release_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: ${{ steps.release_info.outputs.release_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validation Results" >> $GITHUB_STEP_SUMMARY

          if [ -f artifacts/github-release-result.json ]; then
            STATUS=$(jq -r '.status' artifacts/github-release-result.json)
            echo "- **GitHub Release**: ${STATUS}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f artifacts/pypi-version-result.json ]; then
            STATUS=$(jq -r '.status' artifacts/pypi-version-result.json)
            echo "- **PyPI Version**: ${STATUS}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f artifacts/production-health-result.json ]; then
            STATUS=$(jq -r '.status' artifacts/production-health-result.json)
            echo "- **Production Health**: ${STATUS}" >> $GITHUB_STEP_SUMMARY
          fi
