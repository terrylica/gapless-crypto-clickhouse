name: Production Validation

# ADR-0035: CI/CD Production Validation Policy
# Scheduled monitoring for ClickHouse Cloud AWS and Binance CDN infrastructure
# Runs every 6 hours, independent of code changes

on:
  schedule:
    # Every 6 hours (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # Allow manual triggering for testing

permissions:
  contents: read

jobs:
  clickhouse-cloud-validation:
    name: ClickHouse Cloud Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      - name: Run ClickHouse Cloud validation
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          echo "=========================================="
          echo "ClickHouse Cloud Validation"
          echo "=========================================="
          doppler run --project aws-credentials --config prd -- uv run scripts/validate_clickhouse_cloud.py

  binance-cdn-availability:
    name: Binance CDN Availability
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Check Binance CDN availability
        run: |
          echo "=========================================="
          echo "Binance CDN Availability Check"
          echo "=========================================="
          uv run scripts/validate_binance_cdn.py

  simplified-e2e-validation:
    name: Simplified E2E Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      - name: Run Simplified E2E Validation
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          echo "=========================================="
          echo "Simplified E2E Validation (3 Layers)"
          echo "=========================================="
          doppler run --project aws-credentials --config prd -- uv run scripts/validate_e2e_simple.py
