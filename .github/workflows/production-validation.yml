name: Production Validation

# ADR-0035: CI/CD Production Validation Policy
# Scheduled monitoring for ClickHouse Cloud AWS and Binance CDN infrastructure
# Runs every 6 hours, independent of code changes

on:
  schedule:
    # Every 6 hours (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # Allow manual triggering for testing

permissions:
  contents: read

jobs:
  clickhouse-cloud-validation:
    name: ClickHouse Cloud Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python + UV
        uses: ./.github/actions/setup-python-uv

      - name: Setup Doppler CLI
        uses: ./.github/actions/setup-doppler

      - name: Install package from local source
        run: uv pip install --system -e .

      - name: Run ClickHouse Cloud validation
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          echo "=========================================="
          echo "ClickHouse Cloud Validation"
          echo "=========================================="
          doppler run --project aws-credentials --config prd -- python scripts/validate_clickhouse_cloud.py

  binance-cdn-availability:
    name: Binance CDN Availability
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python + UV
        uses: ./.github/actions/setup-python-uv

      - name: Check Binance CDN availability
        run: |
          echo "=========================================="
          echo "Binance CDN Availability Check"
          echo "=========================================="
          uv run scripts/validate_binance_cdn.py

  simplified-e2e-validation:
    name: Simplified E2E Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python + UV
        uses: ./.github/actions/setup-python-uv

      - name: Setup Doppler CLI
        uses: ./.github/actions/setup-doppler

      - name: Install package from local source
        run: uv pip install --system -e .

      - name: Run Simplified E2E Validation
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          echo "=========================================="
          echo "Simplified E2E Validation (3 Layers)"
          echo "=========================================="
          doppler run --project aws-credentials --config prd -- python scripts/validate_e2e_simple.py
